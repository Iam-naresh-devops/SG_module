# Copilot / AI Agent Instructions for terraform-aws-securitygroups-module

Purpose
- Help AI agents be immediately productive when making changes to this Terraform module for AWS Security Groups.

Quick overview
- This repo is a Terraform module that creates an AWS Security Group (`aws_security_group.sg`). Key files: `main.tf`, `variables.tf`, `output.tf`, `README.MD`.
- The module merges `var.common_tags` with a `Name` and `Create_date_time` tag in `main.tf`.
- Output: `sg_id` (see `output.tf`).

How to run locally (use these exact commands)
1. terraform fmt -recursive
2. terraform init
3. terraform validate
4. terraform plan -var 'project=<name>' -var 'environment=<env>' -var 'sg_name=<name>' -var 'vpc_id=<vpc-id>' -var 'from_port=<num>' -var 'to_port=<num>' -var 'protocol=<tcp|udp|...>' -var 'cidr_blocks=["0.0.0.0/0"]'

Code patterns & conventions (explicit, discoverable)
- Tagging: uses merge(var.common_tags, { Name = "${var.project}-${var.environment}-${var.sg_name}", Create_date_time = formatdate("YYYY-MM-DD hh:mm:ss ZZZ", timestamp()) }) (see `main.tf`).
- Outputs: expose `sg_id` via `output.tf`.
- Variable naming: snake_case (e.g., `sg_name`, `vpc_id`, `common_tags`).

Important discoveries / caveats (must verify before modifying)
- vpc_id default: `variables.tf` sets `vpc_id` default = `data.aws_vpc.default.id`. This is not a discoverable data source in the module and a variable default referencing provider/data is likely invalid; callers should pass `vpc_id` explicitly. Verify callers or remove the default.
- Ingress variables are inconsistent: `variables.tf` defines an `ingress_rules` object, but `main.tf` currently uses simple variables (`var.from_port`, `var.to_port`, `var.protocol`, `var.cidr_blocks`) inside a single `ingress` block. If you modify ingress behavior, prefer one of these approaches:
  - Keep single-rule approach (document expectations clearly in README).
  - Migrate to a list(object(...)) or map and use `for_each` on `ingress` with `content { ... }` (preferred for multiple rules). Example pattern:

```hcl
variable "ingress_rules" {
  type = list(object({
    description = string
    from_port   = number
    to_port     = number
    protocol    = string
    cidr_blocks = list(string)
  }))
}

resource "aws_security_group" "sg" {
  # ...

  dynamic "ingress" {
    for_each = var.ingress_rules
    content {
      from_port   = ingress.value.from_port
      to_port     = ingress.value.to_port
      protocol    = ingress.value.protocol
      cidr_blocks = ingress.value.cidr_blocks
    }
  }
}
```

PR checklist for contributors / AI agents (automate these checks)
- Run `terraform fmt -recursive` and `terraform validate` locally. Include these in CI if added.
- If editing variables, update `README.MD` with current required inputs and example usage.
- If changing `ingress` behavior, add an example `examples/` usage or a short example in `README.MD` showing how to pass multiple rules.
- Add or update tests/validation where applicable (e.g., terratest or local plan checks if present in the org).

Who to ask / ownership
- Default metadata in `variables.tf` shows `Admin_email = "admin@corporate.com"` and `Owner = "Naresh"` — try contacting them if module intent is unclear.

What I did not find (ask the maintainer)
- No CI config (e.g., GitHub Actions) or existing agent instruction files were present—ask whether they want automated `terraform fmt | validate` and a PR workflow.
- No examples or tests—ask whether we should add `examples/` and a simple plan-based test.

If something is unclear, ask the maintainer to provide:
- Intended shape for ingress rules (single-rule vs multiple rules). 
- Expected Terraform version and CI requirements.

Feedback requested
- Please review the "Important discoveries / caveats" section and tell me if I should: (a) update the module to support list-based ingress rules, (b) remove/fix the `vpc_id` default, or (c) just document expectations and leave code as-is.

---
(Generated by an automated repository scan — concise, actionable, and conservative: only document patterns visible in the code.)
